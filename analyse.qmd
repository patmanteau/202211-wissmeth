---
title: "Analyse der Framingham Heart Study"
---

# Framingham-Daten

[Quelle](https://search.r-project.org/CRAN/refmans/riskCommunicator/html/framingham.html)

Aus `riskCommunicator` exportiert, um nicht das ganze Paket laden zu müssen.

Beschreibung der Attribute:

|Name|Description|
|----|-----------|
|RANDID|Unique identification number for each participant. Values range from 2448-999312.|
|SEX|Participant sex. 1 = Male (n = 5022), 2 = Female (n = 6605).|
|TOTCHOL|Serum Total Cholesterol (mg/dL). Values range from 107-696.|
|AGE|Age at exam (years). Values range from 32-81.|
|SYSBP|Systolic Blood Pressure (mean of last two of three measurements) (mmHg). Values range from 83.5-295.|
|DIABP|Diastolic Blood Pressure (mean of last two of three measurements) (mmHg). Values range from 30-150.|
|CURSMOKE|Current cigarette smoking at exam. 0 = Not current smoker (n = 6598), 1 = Current smoker (n = 5029).|
|CIGPDAY|Number of cigarettes smoked each day. 0 = Not current smoker. Values range from 0-90 cigarettes per day.|
|BMI|Body Mass Index, weight in kilograms/height meters squared. Values range from 14.43-56.8.|
|DIABETES|Diabetic according to criteria of first exam treated or first exam with casual glucose of 200 mg/dL or more. 0 = Not a diabetic (n = 11097), 1 = Diabetic (n = 530)|
|BPMEDS|Use of Anti-hypertensive medication at exam. 0 = Not currently used (n = 10090), 1 = Current use (n = 944).|
|HEARTRTE|Heart rate (Ventricular rate) in beats/min. Values range from 37-220.|
|GLUCOSE|Casual serum glucose (mg/dL). Values range from 39-478.|
|EDUC|Some high school (1), high school/GED (2), some college/vocational school (3), college (4).|
|PREVCHD|Prevalent Coronary Heart Disease defined as pre-existing Angina Pectoris, Myocardial Infarction (hospitalized, silent or unrecognized), or Coronary Insufficiency (unstable angina). 0 = Free of disease (n = 10785), 1 = Prevalent disease (n = 842).|
|PREVAP|Prevalent Angina Pectoris at exam. 0 = Free of disease (n = 11000), 1 = Prevalent disease (n = 627).|
|PREVMI|Prevalent Myocardial Infarction. 0 = Free of disease (n = 11253), 1 = Prevalent disease (n = 374).|
|PREVSTRK|Prevalent Stroke. 0 = Free of disease (n = 11475), 1 = Prevalent disease (n = 152).|
|PREVHYP|Prevalent Hypertensive. Subject was defined as hypertensive if treated or if second exam at which mean systolic was >=140 mmHg or mean Diastolic >=90 mmHg. 0 = Free of disease (n = 6283), 1 = Prevalent disease (n = 5344).|
|TIME|Number of days since baseline exam. Values range from 0-4854|
|PERIOD|Examination Cycle. 1 = Period 1 (n = 4434), 2 = Period 2 (n = 3930), 3 = Period 3 (n = 3263)|
|HDLC|High Density Lipoprotein Cholesterol (mg/dL). Available for Period 3 only. Values range from 10-189.|
|LDLC|Low Density Lipoprotein Cholesterol (mg/dL). Available for Period 3 only. Values range from 20-565.|
|DEATH|Death from any cause. 0 = Did not occur during followup, 1 = Did occur during followup.|
|ANGINA|Angina Pectoris. 0 = Did not occur during followup, 1 = Did occur during followup.|
|HOSPMI|Hospitalized Myocardial Infarction. 0 = Did not occur during followup, 1 = Did occur during followup.|
|MI_FCHD|Hospitalized Myocardial Infarction or Fatal Coronary Heart Disease. 0 = Did not occur during followup, 1 = Did occur during followup.|
|ANYCHD|Angina Pectoris, Myocardial infarction (Hospitalized and silent or unrecognized), Coronary Insufficiency (Unstable Angina), or Fatal Coronary Heart Disease. 0 = Did not occur during followup, 1 = Did occur during followup.|
|STROKE|Atherothrombotic infarction, Cerebral Embolism, Intracerebral Hemorrhage, or Subarachnoid Hemorrhage or Fatal Cerebrovascular Disease. 0 = Did not occur during followup, 1 = Did occur during followup.|
|CVD|Myocardial infarction (Hospitalized and silent or unrecognized), Fatal Coronary Heart Disease, Atherothrombotic infarction, Cerebral Embolism, Intracerebral Hemorrhage, or Subarachnoid Hemorrhage or Fatal Cerebrovascular Disease. 0 = Did not occur during followup, 1 = Did occur during followup.|
|HYPERTEN|Hypertensive. Defined as the first exam treated for high blood pressure or second exam in which either Systolic is 6 140 mmHg or Diastolic 6 90mmHg. 0 = Did not occur during followup, 1 = Did occur during followup.|
|TIMEAP|Number of days from Baseline exam to first Angina during the followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMEMI|Number of days from Baseline exam to first HOSPMI event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMEMIFC|Number of days from Baseline exam to first MI_FCHD event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMECHD|Number of days from Baseline exam to first ANYCHD event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMESTRK|Number of days from Baseline exam to first STROKE event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMECVD|Number of days from Baseline exam to first CVD event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|
|TIMEDTH|Number of days from Baseline exam to death if occurring during followup or Number of days from Baseline to censor date. Censor date may be end of followup, or last known contact date if subject is lost to followup.|
|TIMEHYP|Number of days from Baseline exam to first HYPERTEN event during followup or Number of days from Baseline to censor date. Censor date may be end of followup, death or last known contact date if subject is lost to followup.|


# Libraries laden

```{r}
#| include: false
library(tidyverse)
library(ggExtra)
library(gridExtra)
library(mosaic)
```

# Daten laden

Daten liegen in `ext.csv`. Spaltentypen explizit definieren, sonst sind's alles Strings (=chr).


```{r}
fram <- read_csv2(
  "ext.csv",
  col_types = list(
    RANDID = col_integer(),
    SEX = col_factor(),
    TOTCHOL = col_integer(),
    AGE = col_integer(),
    SYSBP = col_number(),
    DIABP = col_number(),
    CURSMOKE = col_logical(),
    CIGPDAY = col_integer(),
    BMI = col_number(),
    DIABETES = col_logical(),
    BPMEDS = col_logical(),
    HEARTRTE = col_integer(),
    GLUCOSE = col_integer(),
    EDUC = col_factor(ordered = TRUE),
    PREVCHD = col_logical(),
    PREVAP = col_logical(),
    PREVMI = col_logical(),
    PREVSTRK = col_logical(),
    PREVHYP = col_logical(),
    TIME = col_integer(),
    PERIOD = col_factor(ordered = TRUE),
    HDLC = col_integer(),
    LDLC = col_integer(),
    DEATH = col_logical(),
    ANGINA = col_logical(),
    HOSPMI = col_logical(),
    MI_FCHD = col_logical(),
    ANYCHD = col_logical(),
    STROKE = col_logical(),
    CVD = col_logical(),
    HYPERTEN = col_logical(),
    TIMEAP = col_integer(),
    TIMEMI = col_integer(),
    TIMEMIFC = col_integer(),
    TIMECHD = col_integer(),
    TIMESTRK = col_integer(),
    TIMECVD = col_integer(),
    TIMEDTH = col_integer(),
    TIMEHYP = col_integer()
  )
) |> mutate(SEX = forcats::fct_recode(SEX, "MALE" = "1", "FEMALE" = "2"))

fram
problems(fram)
str(fram)
```

# Forschungsfragen

## Frage 1: Führt ein hoher BMI zu erhöhtem systolischem Blutdruck?

Hypothese: *Jemand mit einem hohen BMI hat einen höheren SYSBP*

- `BMI`: unabhängige Variable
  - verhältnisskaliert (?)
- `SYSBP`: abhängige Variable
  - verhältnisskaliert (?)

### Explorative Datenanalyse

#### Verteilung von BMI und systolischem Blutdruck

Beides sind numerische Variablen, wir schauen uns also mal ihre Verteilung an.

```{r}
#| label: bmi_sysbp_dist
#| fig-cap: Verteilung von Body Mass Index und systolischem Blutdruck
#| warning: false
#| echo: false
bmi_hgram <- fram |>
  ggplot(aes(x=BMI)) +
  geom_histogram(fill="#4477aa", color="#4477aa", binwidth=1, alpha=0.8) + 
  theme_minimal()
  # TODO: 2discuss: Histogramm oder KDE?
  # ggtitle("Verteilung des Body Mass Index") +
  # geom_histogram(fill="#4477aa", color="#4477aa", binwidth=1, alpha=0.8) +
  # geom_density(fill="#4477aa", color="#4477aa", alpha=0.8) +
  

sysbp_hgram_colours <- c('1'='#228833', '5'='#ee6677')

sysbp_hgram <- fram |>
  ggplot(aes(x=SYSBP)) +
  geom_histogram(aes(colour='5', fill='5'), binwidth=5, alpha=0.8) + 
  geom_histogram(aes(colour='1', fill='1'), binwidth=1, alpha=0.8) +
  scale_colour_manual(values=sysbp_hgram_colours,
                      breaks=NULL) +
  scale_fill_manual(values=sysbp_hgram_colours,
                    name='binwidth') +
  theme_minimal()
  #ggtitle("Verteilung des systolischen Blutdrucks") +
  #geom_density(fill="#ee6677", color="#ee6677", alpha=0.8) + 
  

grid.arrange(bmi_hgram, sysbp_hgram)
```

Auffällig: "Runde" Blutdruckwerte - insbesondere 110, 120 und 130 - sind überrepräsentiert.


#### 

```{r}
# Besser: Konturplot (2D-Kerndichteschätzung) mit transparenter Punktwolke in der richtigen Farbe...
bmi_sysbp_plot <- ggplot(fram, aes(x=BMI, y=SYSBP) ) +
  geom_point(alpha=0.4, colour="#7a0177") +
  stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", alpha=0.8) +
  scale_fill_distiller(palette="RdPu", direction=-1) +
  theme_minimal() +
  theme(
    legend.position='none'
  )

# ...mit Verteilung an den Rändern
bmi_sysbp_plot_full <- ggMarginal(
  bmi_sysbp_plot,
  type="histogram",
  xparams=list(colour="#4477aa", fill="#4477aa", alpha=0.8, binwidth=1),
  yparams=list(colour="#ee6677", fill="#ee6677", alpha=0.8, binwidth=5)
)
bmi_sysbp_plot_full
```


#### Lagemaße

```{r}
favstats(~ BMI, data=fram)
favstats(~ SYSBP, data=fram)
```

### Lineare Regression BMI SYSBP

```{r}
linReg <- lm(SYSBP ~ BMI, data=fram)
summary(linReg)

# plotModel macht leider auch overplotteten Käse. Da bleibt
# sogar eine entscheidende Erkenntnis auf der Strecke, die
# einen im Konturplot praktisch anspringt...
plotModel(linReg)

# ...die Regressionsgerade verfehlt nämlich das Zentrum der
# Punktwolke.
# TODO: hängt das mit dem niedrigen $r^{2}$ zusammen?
bmi_sysbp_plot +
  geom_abline(color='#228833',
              size = 1,
              slope=coef(linReg)['BMI'],
              intercept=coef(linReg)['(Intercept)'])

#bmi_sysbp_plot +
#  geom_smooth(method='lm')

```

$p \lt 2^{-16}$ - der Zusammenhang ist signifikant, mit jedem BMI-Punkt steigt
der systolische Blutdruck im Mittel um $\approx 1.5$

Wir sehen im Graphen, dass die Regressionsgerade das "heiße" Zentrum des Streudiagramms verfehlt.

$r^{2} = 0.0756$, der BMI erklärt alleine also nur einen geringen Anteil der systematischen Varianz (für einen physiologischen Meßwert aber trotzdem ne ganze Menge)



### Bootstrapping

Graph von Bootstrapverteilung und Konfidenzintervall berechnen

Graph von Nullverteilung und Konfidenzintervall berechnen

Beide vergleichen, um Fehler 1. Art auszuschließen (die überlappen nicht nur nicht, die sind komplett unterschiedlich)

TODO: beide in einen Graphen


```{r}
# Bootstrapping
set.seed(69420) # Reproduzierbarkeit

Bootstr_1 <- do(10000)* lm(SYSBP ~ BMI, data=resample(fram))
summary(Bootstr_1)

# Standardabweichung
sd(~ BMI, data=Bootstr_1) 

# Konfidenzintervall alpha = 1 Prozent
qdata(~ BMI, data=Bootstr_1, p=c(0.005, 0.995))  
```

```{r}
# Nullverteilung
set.seed(69420) # Reproduzierbarkeit

Nullver_1 <- do(10000) * lm(SYSBP ~ shuffle(BMI), data=resample(fram)) 

gf_histogram(~ BMI, data=Nullver_1)

# Konfidenzintervall alpha = 1 Prozent
qdata(~ BMI, data=Nullver_1, p=c(0.005, 0.995)) 

summary(Nullver_1)

cor(SYSBP ~ BMI, data=fram) # Korrelation aus Datensatz

coef(LinReg) # Koeffizient aus Linearer Regression aus Datensatz

ggplot(rbind(Bootstr_1, Nullver_1), aes(x=BMI)) + 
  geom_histogram(data = Bootstr_1, fill = "#4477aa", colour = "#4477aa", alpha = 0.8, binwidth = 0.01) + 
  geom_histogram(data = Nullver_1, fill = "#ee6677", colour = "#ee6677", alpha = 0.8, binwidth = 0.01) +
  theme_minimal()
```



## Frage 2: Begünstigt Diabetes schwere Gefäßerkrankungen?

Hypothese: *Jemand mit bekannter Diabetes Diagnose hat eine höhere Chance im Beobachtungszeitraum zu versterben*

- `GLUCOSE`: unabhängige Variable
  - verhältnisskaliert
- `CVD`: abhängige Variable
  - binärskaliert

Triggerwarnung nicht vergessen, in der Präsentation darauf hinweisen, dass es sich hier um Daten aus den 1950er/1960er Jahren handelt.

### Reproduzierbarkeit

```{r}
set.seed(69420)
```

### Explorative Datenanalyse

TODO: Visualisierungen
```{r}
# Gruppengröße
cvd_size <- fram |>
  group_by(CVD) |>
  summarise(num=n())

gluc_cvd_plot <- fram |>
  left_join(cvd_size) |>
  mutate(CVD = paste0(CVD, "\n", "n=", num)) |>
  ggplot(aes(x=CVD, y=GLUCOSE, fill=CVD)) +
    geom_jitter(alpha = 0.2, color="grey", fill="grey") + 
    geom_violin(width=0.9, alpha=0.8, adjust=.5) +
    geom_boxplot(width=0.2, color="#332288", fill="#332288", alpha=0.6, outlier.shape = NA) +
    coord_trans(y="log10") +
    scale_fill_brewer(type="qual") +
    theme_minimal() +
    theme(
      legend.position="none"
    )
gluc_cvd_plot


# mit ECDF sieht man den kleinen Unterschied etwas besser
fram |> ggplot(aes(x=GLUCOSE, color=CVD)) +
  stat_ecdf(geom = "step", size = 1, alpha = 0.8) +
  theme_minimal()


```

### Rel. Häufigkeit von Diabetikern in der Studie

```{r}
prop(~ DIABETES, data=fram)
```


```{r}
reg <- lm(CVD ~ DIABETES, data=fram)
summary(reg)
mosaicplot(CVD ~ DIABETES, data=fram)
count(fram$CVD)
count(fram$DEATH)
mosaicplot(DEATH ~ DIABETES, data=fram)
```

### Logistische Regression

```{r}
fram <- fram |>
  mutate(CVDNUM = if_else(CVD == TRUE, 1, 0))

logreg1 <- glm(CVDNUM ~ GLUCOSE, family=binomial("logit"), data=fram)
summary(logreg1)


plotModel(logreg1)


log_smooth <- function(...) {
  geom_smooth(method = "glm", se = FALSE, color="#ee7733", method.args = list(family = "binomial"), ...)
}

logRegPlot <- fram |> ggplot(aes(x=GLUCOSE, y=CVDNUM)) +
  geom_jitter(alpha=0.02, height=0.3) +
  stat_bin2d(binwidth = c(1, 0.04), aes(colour=..count..)) + 
  log_smooth(formula = y ~ x) +
  theme_minimal() +
  theme(
    legend.position = "none"
  )
  
logRegPlot

```

### Bootstrapping

```{r}
#logreg2 <- do(100) * glm(CVD ~ GLUCOSE, family=binomial("logit"), data=resample(fram))
#summary(logreg2)
#gf_histogram(logreg2)
```

### Benjamins Code

```{r}
fram <- fram |>
  mutate(CVDNUM = if_else(CVD == TRUE, 1, 0))

# Logistische Rergession
logReg <- glm(CVDNUM ~ GLUCOSE, data=fram, family=binomial("logit")) 

summary(logReg)

plotModel(logReg)

set.seed(69420)

Bootstr_2 <- do(10000) * glm(CVD ~ GLUCOSE, data=resample(Data), family=binomial("logit"))

summary(Bootstr_2)

gf_histogram(~ GLUCOSE, data=Bootstr_2)

set.seed(69420)

Nullver_2 <-do(10000) * glm(CVD ~ shuffle(GLUCOSE), data=resample(Data), family=binomial("logit"))

summary(Nullver_2)

gl_histogram(~ GLUCOSE, data=Nullver_2)


# Anteil von Koeffizeinten aus der Nullverteilung der sich mit der Range der
# Koeffizienten aus dem Bootsrapping überschneidet oder größer ist
prop(~ abs(GLUCOSE) >= abs(coef(Bootstr_2) [2]), data=Nullver_2) 

mosaicplot(CVD ~ DIABETES, data=Data)

# Wahrscheinlichkeit eine CVD zu erleiden im Verlauf der Studie
prop(~ CVD, data=Data) 
```

